{% extends "arrivals/base.html" %}
{% load static %}

{% block title %}실시간 지하철 도착 정보{% endblock %}

{% block content %}
<div class="container">
    <h1 class="title">실시간 지하철 도착 정보</h1>

    {# 로그인한 사용자가 선호역을 설정했을 경우 표시 #}
    {% if user.is_authenticated and preferred_stations %}
    <div class="preferred-stations-section box">
        <h2 class="subtitle is-5">내 선호역</h2>
        <div class="buttons">
            {% for p_station in preferred_stations %}
                {% if p_station %}
                {# 각 선호역 버튼 클릭 시 해당 역으로 검색 폼 제출 #}
                <form action="{% url 'arrivals:index' %}" method="get" style="display:inline;">
                    <input type="hidden" name="station" value="{{ p_station }}">
                    <button type="submit" class="button is-info is-light">{{ p_station }}</button>
                </form>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {# 지하철역 검색 폼 #}
    <div class="search-section box">
        <form action="{% url 'arrivals:index' %}" method="get">
            <div class="field has-addons">
                <div class="control is-expanded">
                    {{ form.station }}
                </div>
                <div class="control">
                    <button type="submit" class="button is-primary">검색</button>
                </div>
            </div>
            {% if form.station.errors %}
                <p class="help is-danger">{{ form.station.errors }}</p>
            {% endif %}
        </form>
    </div>

    {# 검색 결과 표시 #}
    {% if station_name %}
    <h2 class="subtitle is-4 mt-5">{{ station_name }}역 실시간 도착 정보</h2>
    {% if arrivals_data.error %}
        <div class="notification is-danger">{{ arrivals_data.error }}</div>
    {% elif arrivals_data.groups %}
        {% for key, group in arrivals_data.groups.items %}
            <div class="box mb-4">
                <h3 class="title is-5">{{ key.0 }}호선 ({{ key.1 }})</h3> {# key.0은 지하철 노선 ID, key.1은 상행/하행 #}
                {% for arrival in group %}<div class="block"><p><strong>{{ arrival.trainLineNm }}</strong>: {{ arrival.arvlMsg2 }} ({{ arrival.barvlDt }}초)</p></div>{% endfor %}
            </div>
        {% empty %}<div class="notification is-warning">{{ station_name }}역에 대한 실시간 도착 정보가 없습니다.</div>
        {% endfor %}
    {% else %}<div class="notification is-warning">{{ station_name }}역에 대한 실시간 도착 정보가 없습니다.</div>
    {% endif %}
    {% endif %}
</div>
{% endblock %}